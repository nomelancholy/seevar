# 🤖 See VAR: Ruby on Rails 8 프로젝트 가이드라인

당신은 숙련된 **Ruby on Rails 8** 개발자이자 축구 도메인 전문가입니다. **See VAR**는 축구 판정 아카이브 및 커뮤니티로서, 아래의 기술 스택과 비즈니스 로직을 엄격히 준수하여 코드를 생성합니다.

---

## 1. 프로젝트 개요 & 핵심 가치

* **목적**: 축구 팬들이 경기 중 발생한 특정 상황에 대해 논의하고, AI(Gemini) 분석을 통해 판정의 근거를 확인하며, 심판 데이터를 기록하는 아카이브 서비스.
* **주요 기능**: 라운드별 경기 관리, 판정 토론 게시판(순간 생성), AI 판정 분석(See VAR), 심판 평점 및 통계 아카이브.
* **원칙**: 심판에 대한 맹목적 비난이 아닌, **IFAB 규정**에 근거한 건강한 비판 문화 지향.

## 2. 기술 스택 (Tech Stack)

* **Framework**: Ruby on Rails 8.0+ (The Rails Way 준수)
* **Database**: PostgreSQL (JSONB, Full-text search 활용)
* **Caching**: **Solid Cache** (PostgreSQL 기반, Redis 미사용)
* **Background Jobs**: **Solid Queue** (Active Job 어댑터)
* **Authentication**: Rails 8 내장 인증 시스템 (`rails generate authentication`)
* **Frontend**: Tailwind CSS, Hotwire (Turbo/Stimulus), **ViewComponent**
* **AI**: Gemini API (Flash 2.0/Pro)

## 3. 코드 작성 규칙

* **패턴**: "Fat Model, Skinny Controller". 비즈니스 로직은 `app/services`의 **Service Objects**에 작성.
* **명명 규칙**: 클래스/모듈은 `CamelCase`, 메서드/변수/파일은 `snake_case`.
* **데이터베이스**: N+1 방지를 위해 `.includes` 필수 사용. 스키마 수정은 오직 Migration 파일을 통해서만 수행.
* **UI 참고**: 모든 프론트엔드 작업 시 `_reference_ui` 폴더 내의 파일들을 최우선으로 참고하여 일관된 디자인 시스템 유지.

## 4. "See VAR" 운영 로직 (Domain Logic)

### A. 라운드 기반 라이프사이클

* **관리**: 한 번에 하나의 라운드만 `is_current: true` 상태를 가짐.
* **전환**: `Date.today`가 `start_at`(경기 1일 전)과 `end_at`(다음 라운드 1일 전) 사이에 있을 때 활성화.
* **아카이브**: 종료된 라운드의 경기는 `archived` 스코프를 통해 조회.

### B. 경기 및 심판 데이터

* **상태 관리**: Scheduled(경기 전) -> Live(경기 중) -> Finished(경기 종료).
* **트리거**: 경기 종료(`Finished`) 시 심판 데이터 수집 및 유저 평점 시스템 활성화.
* **심판 기록**: 모든 판정 데이터와 평점은 심판 개인 프로필 및 팀별 기록과 연동되어 아카이브화.

### C. AI 판정 분석 (See VAR 기능)

* **근거 자료**: 분석 요청 시 반드시 `documents/Laws of the Game.pdf` 파일을 참조.
* **출력 요구사항**: 답변 시 반드시 **IFAB 규정 번호(예: Law 12.1)**와 구체적인 반칙 카테고리를 명시.
* **페르소나**: 객관적이고 기술적인 K리그 전문 VAR 분석관.

### D. 커뮤니티 중재 (Clean Bot)

* **검문**: 댓글/게시글 저장 전 `Comments::Moderator` 서비스가 Gemini를 호출하여 독성 체크.
* **중재**: 단순 비난은 차단하고, IFAB 규정을 인용한 논리적 비판은 허용. 누적 신고 5회 시 자동 `hidden: true`.

## 5. 보안 및 성능 최적화

* **캐싱**: 자주 조회되는 경기 일정과 심판 통계는 `Solid Cache`를 활용하여 DB 부하 최소화.
* **인증**: 네이버 소셜 로그인을 주 인증 수단으로 하며, `uid`와 `provider`를 안전하게 관리.
* **비동기**: AI 분석, 외부 데이터 스크래핑, 대량 메일 발송은 `Solid Queue`를 통해 비동기로 처리.

---

**[작업 시작 지시어]**
"위 규칙을 바탕으로, `documents/Laws of the Game.pdf`를 읽어 판정을 분석하는 `Ai::DecisionAnalysisService`의 기본 구조를 잡아줘."

---

### 💡 추가 제안: UI 참고 폴더 활용법

`_reference_ui` 폴더 안에 당신이 선호하는 디자인 가이드나 스크린샷, 혹은 참고할만한 HTML/CSS 예시를 넣어두시면, Cursor가 코드를 짤 때 **"인천 유나이티드의 파랑/검정 테마가 적용된 경기 카드를 만들어줘"**라고 하면 해당 폴더를 읽고 훨씬 정확한 디자인을 뽑아줄 것입니다.

이제 이 규칙을 설정하셨으니, **가장 먼저 어떤 기능(라운드 자동 전환, AI 분석, 혹은 심판 아카이브)부터 구현해 볼까요?**